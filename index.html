<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Medidas - Ferro, Aço e Alumínio</title>
    <!-- 1. Adicionando o Tailwind CSS para um visual moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuração do Tailwind (opcional, mas bom para fontes)
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <style>
        /* Estilo para a fonte Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Classe para o resultado não quebrar linha de forma estranha */
        .resultado-item {
            word-break: break-word;
        }

        /* NOVO: Estilos para a tabela da régua */
        #sidebar-regua table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
            font-size: 0.875rem; /* text-sm */
        }
        #sidebar-regua th {
            background-color: #374151; /* bg-gray-700 */
            color: #FFFFFF; /* text-white */
            padding: 0.5rem 0.75rem;
            text-align: left;
            font-weight: 600; /* font-semibold */
        }
        #sidebar-regua td {
            border-bottom: 1px solid #4B5563; /* border-gray-600 */
            padding: 0.5rem 0.75rem;
        }
        #sidebar-regua tr:last-child td {
            border-bottom: none;
        }
        #sidebar-regua h4 {
            font-size: 1rem; /* text-base */
            font-weight: 700; /* font-bold */
            color: #93C5FD; /* text-blue-300 */
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #4B5563; /* border-gray-600 */
            padding-bottom: 0.25rem;
        }
        
        /* MUDANÇA: Estilo para as novas descrições */
        #sidebar-regua p {
            font-size: 0.875rem; /* text-sm */
            color: #D1D5DB; /* text-gray-300 */
            font-style: italic;
            margin-bottom: 0.5rem; /* mb-2 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-10">

    <!-- NOVO: Botão flutuante para abrir a régua -->
    <button onclick="toggleSidebar()" title="Abrir Régua de Conversão"
            class="fixed top-4 left-4 z-50 bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
    </button>

    <!-- NOVO: Overlay para fechar o menu ao clicar fora -->
    <div id="sidebar-overlay" onclick="toggleSidebar()"
         class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden transition-opacity duration-300 ease-in-out">
    </div>

    <!-- NOVO: Sidebar (Régua) COM DESCRIÇÕES -->
    <div id="sidebar-regua" class="fixed top-0 left-0 h-screen w-80 bg-gray-900 text-gray-200 shadow-xl z-40
                 transform -translate-x-full transition-transform duration-300 ease-in-out
                 overflow-y-auto p-5">
        
        <!-- Botão de Fechar (dentro) -->
        <button onclick="toggleSidebar()" class="absolute top-4 right-4 text-gray-400 hover:text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>

        <h3 class="text-xl font-bold text-white mb-6">Régua de Conversão</h3>
        
        <!-- Conteúdo da Régua (tabelas) -->
        
        <h4>CH Fina Fria</h4>
        <!-- DESCRIÇÃO ADICIONADA -->
        <p>Usada em serralheria leve, móveis de aço, e estamparia (ex: calhas, perfis simples).</p>
        <table>
            <thead><tr><th>Bwg</th><th>Mm</th></tr></thead>
            <tbody>
                <tr><td>30</td><td>0.30</td></tr>
                <tr><td>28</td><td>0.38</td></tr>
                <tr><td>26</td><td>0.45</td></tr>
                <tr><td>24</td><td>0.60</td></tr>
                <tr><td>22</td><td>0.75</td></tr>
                <tr><td>20</td><td>0.90</td></tr>
                <tr><td>19</td><td>1.06</td></tr>
                <tr><td>18</td><td>1.20</td></tr>
                <tr><td>16</td><td>1.50</td></tr>
            </tbody>
        </table>

        <h4>CH Fina Quente</h4>
        <!-- DESCRIÇÃO ADICIONADA -->
        <p>Para serralheria geral e estruturas que exigem mais resistência (ex: tubos, perfis U).</p>
        <table>
            <thead><tr><th>Nº</th><th>Mm</th></tr></thead>
            <tbody>
                <tr><td>14</td><td>2.00</td></tr>
                <tr><td>13</td><td>2.25</td></tr>
                <tr><td>12</td><td>2.65</td></tr>
                <tr><td>11</td><td>3.00</td></tr>
            </tbody>
        </table>

        <h4>CH Grossa</h4>
        <!-- DESCRIÇÃO ADICIONADA -->
        <p>Usada em estruturas pesadas, bases de máquinas, e aplicações de alta resistência.</p>
        <table>
            <thead><tr><th>Pol</th><th>Mm</th></tr></thead>
            <tbody>
                <tr><td>3/16"</td><td>4.75</td></tr>
                <tr><td>1/4"</td><td>6.30</td></tr>
                <tr><td>5/16"</td><td>8.00</td></tr>
                <tr><td>3/8"</td><td>9.50</td></tr>
                <tr><td>1/2"</td><td>12.50</td></tr>
            </tbody>
        </table>

        <h4>CH Galv (Zincada)</h4>
        <!-- DESCRIÇÃO ADICIONADA -->
        <p>Chapa com revestimento de zinco para resistência à corrosão (ex: telhas, calhas, portões).</p>
        <table>
            <thead><tr><th>Bwg</th><th>Mm</th></tr></thead>
            <tbody>
                <tr><td>30</td><td>0.35</td></tr>
                <tr><td>28</td><td>0.43</td></tr>
                <tr><td>26</td><td>0.50</td></tr>
                <tr><td>24</td><td>0.65</td></tr>
                <tr><td>22</td><td>0.80</td></tr>
                <tr><td>20</td><td>0.95</td></tr>
                <tr><td>18</td><td>1.25</td></tr>
                <tr><td>16</td><td>1.55</td></tr>
                <tr><td>14</td><td>1.95</td></tr>
            </tbody>
        </table>

        <h4>TB Industrial</h4>
        <!-- DESCRIÇÃO ADICIONADA -->
        <p>Tubos (redondos, quadrados, retangulares) para serralheria (ex: grades, portões). A polegada é a medida externa real.</p>
        <table>
            <thead><tr><th>Pol</th><th>Mm</th></tr></thead>
            <tbody>
                <tr><td>1/2"</td><td>12.70</td></tr>
                <tr><td>5/8"</td><td>15.87</td></tr>
                <tr><td>3/4"</td><td>19.05</td></tr>
                <tr><td>13/16"</td><td>20.70</td></tr>
                <tr><td>7/8"</td><td>22.22</td></tr>
                <tr><td>1"</td><td>25.40</td></tr>
                <tr><td>1.1/4"</td><td>31.75</td></tr>
                <tr><td>1.1/2"</td><td>38.10</td></tr>
                <tr><td>2"</td><td>50.80</td></tr>
                <tr><td>2.1/2"</td><td>63.50</td></tr>
                <tr><td>3"</td><td>76.20</td></tr>
                <tr><td>3.1/2"</td><td>88.90</td></tr>
                <tr><td>4"</td><td>101.60</td></tr>
            </tbody>
        </table>

        <h4>TB PA Dimensão Externa</h4>
        <!-- DESCRIÇÃO ADICIONADA -->
        <p>Tubos para condução (ex: NBR 5580). A Polegada é "nominal" (identificação), não a medida externa real.</p>
        <table>
            <thead><tr><th>Pol</th><th>Mm</th></tr></thead>
            <tbody>
                <tr><td>1/2"</td><td>21.20</td></tr>
                <tr><td>3/4"</td><td>26.70</td></tr>
                <tr><td>1"</td><td>33.40</td></tr>
                <tr><td>1.1/4"</td><td>42.40</td></tr>
                <tr><td>1.1/2"</td><td>48.10</td></tr>
                <tr><td>2"</td><td>59.90</td></tr>
                <tr><td>2.1/2"</td><td>76.20</td></tr>
                <tr><td>3"</td><td>88.90</td></tr>
            </tbody>
        </table>

        <h4>Perfil "U" Simples</h4>
        <!-- DESCRIÇÃO ADICIONADA -->
        <p>Perfil em "U" sem dobras extras nas abas. Usado em vigas leves e acabamentos.</p>
        <table>
            <thead><tr><th>Pol</th><th>Mm</th></tr></thead>
            <tbody>
                <tr><td>2"</td><td>50 x 25</td></tr>
                <tr><td>3"</td><td>75 x 40</td></tr>
                <tr><td>4"</td><td>100 x 40</td></tr>
                <tr><td>4"</td><td>100 x 50</td></tr>
                <tr><td>5"</td><td>125 x 50</td></tr>
                <tr><td>6"</td><td>150 x 50</td></tr>
            </tbody>
        </table>

        <h4>Perfil Enrijecido</h4>
        <!-- DESCRIÇÃO ADICIONADA -->
        <p>Perfil "U" com dobras adicionais nas abas para maior resistência (ex: terças de telhado).</p>
        <table>
            <thead><tr><th>Pol</th><th>Mm</th></tr></thead>
            <tbody>
                <tr><td>2"</td><td>50 x 25 x 10</td></tr>
                <tr><td>3"</td><td>75 x 40 x 10</td></tr>
                <tr><td>4"</td><td>100 x 40 x 15</td></tr>
                <tr><td>4"</td><td>100 x 50 x 15</td></tr>
                <tr><td>5"</td><td>127 x 50 x 20</td></tr>
                <tr><td>6"</td><td>150 x 60 x 20</td></tr>
            </tbody>
        </table>

        <h4>Perfil de Encaixe</h4>
        <!-- DESCRIÇÃO ADICIONADA -->
        <p>Perfis para sistemas específicos, como portas de aço de enrolar ou divisórias.</p>
        <table>
            <thead><tr><th>Mm</th></tr></thead>
            <tbody>
                <tr><td>68 x 30</td></tr>
                <tr><td>93 x 30</td></tr>
            </tbody>
        </table>
    </div>
    
    <!-- MUDANÇA: Adicionado 'relative' e 'z-10' para o container principal ficar acima do overlay, mas abaixo do sidebar -->
    <div class="container w-full max-w-2xl mx-auto p-4 md:p-8 relative z-10">
        <div class="bg-white rounded-lg shadow-xl p-6 md:p-8">
            
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Gerador de Cadastro</h1>
            <p class="text-gray-600 mb-6">Digite as medidas da nota fiscal (em mm) e selecione o material.</p>

            <div class="space-y-4">
                
                <!-- NOVO: Seletor de Material -->
                <div>
                    <label for="tipoMaterial" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Material</label>
                    <select id="tipoMaterial" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                        <option value="auto">-- Auto-Detectar (Padrão) --</option>
                        <option value="tubo_retangular">Tubo Quadrado / Retangular</option>
                        <option value="tubo_redondo">Tubo Redondo (Industrial / Patente)</option>
                        <option value="cantoneira">Cantoneira (L)</option>
                        <option value="barra_chata">Barra Chata</option>
                        <option value="perfil_u">Perfil U (Simples / Enrijecido)</option>
                        <option value="perfil_i_w">Perfil I / W (Viga)</option>
                        <option value="chapa">Chapa (Bobina / Pedaço)</option>
                        <option value="chapa_zincada">Chapa Zincada / Galvanizada</option>
                    </select>
                </div>

                <div>
                    <label for="entrada" class="block text-sm font-medium text-gray-700 mb-1">Medidas (mm)</label>
                    <input id="entrada" type="text" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                           placeholder="Ex: 50x30x2.0 ou 101.6x3.175">
                </div>
                
                <button onclick="processar()" 
                        class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200">
                    Gerar Cadastro
                </button>
            </div>

            <!-- 2. Área de resultado melhorada -->
            <div id="saida-container" class="mt-8 border-t border-gray-200 pt-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Resultado</h2>
                <div id="saida" class="space-y-3">
                    <!-- O resultado será inserido aqui pelo JavaScript -->
                    <p class="text-gray-500">Aguardando entrada...</p>
                </div>
            </div>

            <!-- 4. NOVA SEÇÃO: Inclusão no Inventário -->
            <div id="secao-inclusao" class="mt-6 border-t border-gray-200 pt-6">
                
                <!-- Botão para abrir o formulário de inclusão -->
                <button id="btn-abrir-inclusao" onclick="abrirFormInclusao()"
                        class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors duration-200 hidden">
                    + Incluir no Inventário
                </button>

                <!-- Formulário de Inclusão (inicialmente oculto) -->
                <div id="form-inclusao" class="hidden space-y-4 p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h3 class="text-lg font-semibold text-gray-800">Adicionar Item da Nota Fiscal</h3>
                    <!-- NOVO: Texto de ajuda para decimais -->
                    <p class="text-sm text-gray-600 -mt-2">Use vírgula (,) ou ponto (.) para casas decimais.</p>
                    
                    <div>
                        <label for="peso-total" class="block text-sm font-medium text-gray-700">Peso Total (Kg)</label>
                        <!-- MUDANÇA: type="number" para "text" com inputmode="decimal" para aceitar vírgula -->
                        <input type="text" inputmode="decimal" id="peso-total" placeholder="Ex: 1500,50" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="peso-unidade" class="block text-sm font-medium text-gray-700">Peso Unidade (Kg)</label>
                        <!-- MUDANÇA: type="number" para "text" com inputmode="decimal" -->
                        <input type="text" inputmode="decimal" id="peso-unidade" placeholder="Ex: 55,30" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="valor-total" class="block text-sm font-medium text-gray-700">Valor Total (R$)</label>
                        <!-- MUDANÇA: type="number" para "text" com inputmode="decimal" -->
                        <input type="text" inputmode="decimal" id="valor-total" placeholder="Ex: 8540,25" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Mensagem de erro -->
                    <div id="inclusao-erro" class="text-red-600 text-sm font-medium"></div>

                    <!-- Botões de Ação -->
                    <div class="flex space-x-4">
                        <!-- ID alterado para podermos mudar o texto (Confirmar / Salvar Alteração) -->
                        <button id="btn-confirmar-inclusao" onclick="confirmarInclusao()" class="flex-1 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Confirmar</button>
                        <button onclick="cancelarInclusao()" class="flex-1 bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
                    </div>
                    
                    <!-- NOVO: Campo oculto para guardar o ID do item em edição -->
                    <input type="hidden" id="edit-item-id">
                </div>
            </div>

            <!-- 5. NOVA SEÇÃO: Lista de Itens Incluídos -->
            <div id="lista-inventario-container" class="mt-8">
                <!-- NOVO: Botão de Exportar Log -->
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">Itens Incluídos</h2>
                    <button id="btn-exportar" onclick="exportarLog()" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-sm hover:bg-gray-700 transition-colors hidden">
                        Exportar Log (.txt)
                    </button>
                </div>
                <div id="lista-inventario" class="space-y-4">
                    <!-- Itens serão adicionados aqui pela função renderInventario() -->
                </div>
            </div>

            <!-- 6. NOVA SEÇÃO: Log Detalhado na Tela -->
            <div id="log-container" class="mt-8 hidden"> <!-- Começa oculto -->
                <!-- MUDANÇA: Adicionado botão de toggle -->
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">Log Detalhado</h2>
                    <button id="btn-toggle-log" onclick="toggleLog()" class="text-sm text-blue-600 hover:text-blue-800 font-medium">Esconder</button>
                </div>
                <pre id="log-na-tela" class="bg-gray-900 text-white p-4 rounded-lg overflow-x-auto text-sm shadow-inner">
                    <!-- O conteúdo do log será injetado aqui -->
                </pre>
            </div>

        </div>
        
        <p class="text-center text-gray-500 text-sm mt-6">
            Nota: A lógica de "Chapa" (CH) é aplicada para Aço/Ferro. Alumínio e Inox geralmente usam a espessura em mm ou polegadas.
        </p>
    </div>

<script>
    // 3. Lógica JavaScript Refatorada e Melhorada
    
    // Variável global para guardar o último cadastro gerado
    let ultimoCadastroSugerido = '';
    
    // NOVO: "Banco de dados" em memória para a lista de inventário
    let inventario = [];
    let nextId = 0; // Gerador de ID simples

    /**
     * Converte milímetros para polegadas.
     */
    function mmParaInch(valor) {
        return valor / 25.4;
    }

    /**
     * Arredonda o valor em MM para a fração de polegada comercial mais próxima.
     * Esta é uma versão expandida da sua lógica original.
     */
    function arredondaComercial(valorMm) {
        const inch = mmParaInch(valorMm);
        
        // Tolerâncias
        const tolFracao = 0.02;  // Tolerância justa para frações (aprox 0.5mm)
        const tolPolegada = 0.15; // Tolerância larga para polegadas cheias

        // Polegadas Cheias (1" a 6") - Expandido
        if (Math.abs(inch - 1) < tolPolegada) return '1"';
        if (Math.abs(inch - 1.25) < tolPolegada) return '1.1/4"';
        if (Math.abs(inch - 1.5) < tolPolegada) return '1.1/2"';
        if (Math.abs(inch - 1.75) < tolPolegada) return '1.3/4"';
        if (Math.abs(inch - 2) < tolPolegada) return '2"';
        if (Math.abs(inch - 2.5) < tolPolegada) return '2.1/2"';
        if (Math.abs(inch - 3) < tolPolegada) return '3"';
        if (Math.abs(inch - 4) < tolPolegada) return '4"';
        if (Math.abs(inch - 5) < tolPolegada) return '5"';
        if (Math.abs(inch - 6) < tolPolegada) return '6"';
        
        // Frações Comuns (1/8" a 1")
        if (Math.abs(inch - 0.125) < tolFracao) return '1/8"';   // 3.175mm
        if (Math.abs(inch - 0.1875) < tolFracao) return '3/16"'; // 4.76mm
        if (Math.abs(inch - 0.25) < tolFracao) return '1/4"';    // 6.35mm
        if (Math.abs(inch - 0.3125) < tolFracao) return '5/16"'; // 7.93mm
        if (Math.abs(inch - 0.375) < tolFracao) return '3/8"';   // 9.52mm
        if (Math.abs(inch - 0.5) < tolFracao) return '1/2"';     // 12.7mm
        if (Math.abs(inch - 0.625) < tolFracao) return '5/8"';   // 15.87mm
        if (Math.abs(inch - 0.75) < tolFracao) return '3/4"';    // 19.05mm
        if (Math.abs(inch - 0.875) < tolFracao) return '7/8"';   // 22.22mm

        // Se não encontrar uma fração exata, retorna a conversão decimal
        return inch.toFixed(3).replace('.', ',') + '"';
    }

    /**
     * Converte a espessura em mm para a Chapa (gauge) correspondente.
     * Focada em Aço Carbono (Ferro).
     */
    function detectarChapa(espMm) {

    if (espMm >= 5.5) return 'CH 1/4"';       // 6,35 mm
    if (espMm >= 4.2) return 'CH 3/16"';      // 4,75 mm
    if (espMm >= 2.8) return 'CH 11';         // 3,05 mm
    if (espMm >= 2.3) return 'CH 12';         // 2,66 mm
    if (espMm >= 1.7) return 'CH 14';         // 1,90 mm
    if (espMm >= 1.3) return 'CH 16';         // 1,52 mm
    if (espMm >= 1.0) return 'CH 18';         // 1,21 mm
    if (espMm >= 0.80) return 'CH 20';        // 0,90 mm
    if (espMm >= 0.65) return 'CH 22';        // 0,75 mm
    if (espMm >= 0.50) return 'CH 24';        // 0,63 mm
    if (espMm >= 0.35) return 'CH 26';        // 0,45 mm

    return '';
}


    /**
     * Tenta adivinhar o material com base no número de medidas.
     * Esta é a lógica "auto"
     */
    function autoDetectarMaterial(partes) {
        const len = partes.length;
        
        // --- NOVA LÓGICA ---
        // Se qualquer parte for maior que 500, é quase certo que é uma chapa
        if (partes.some(p => p > 500)) {
            return 'chapa';
        }
        // --- FIM DA NOVA LÓGICA ---

        if (len === 4) {
            // 75x40x15x2.65 -> Provavelmente Perfil U Enrijecido
            return 'perfil_u';
        }
        if (len === 3) {
            // 50x30x2.0 (Tubo Retangular)
            // 50x50x3.0 (Tubo Quadrado ou Cantoneira)
            // 75x40x3.0 (Perfil U Simples ou Cantoneira)
            // 152x76x5 (Perfil I)
            if (partes[0] > 100 && partes[1] > 70) return 'perfil_i_w';
            if (partes[0] === partes[1]) return 'tubo_retangular'; // Suposição (pode ser Cantoneira)
            return 'tubo_retangular'; // Suposição
        }
        if (len === 2) {
            // 50.8x2.0 (Tubo Redondo)
            // 50.8x3.175 (Barra Chata)
            // 1200x2.0 (Chapa) - (Lógica antiga movida para cima)
            if (partes[0] > 40 && partes[1] > 10) return 'barra_chata'; // Ex: 50.8 x 12.7 (2" x 1/2")
            if (partes[0] > 40) return 'tubo_redondo'; // Suposição (ex: 50.8x2.0)
            return 'barra_chata'; // Suposição (ex: 25.4x3.175)
        }
        if (len === 1) {
            // 2.65 (Espessura de chapa)
            return 'chapa';
        }
        return 'auto'; // Falhou em detectar
    }

    /**
     * Exibe o resultado formatado na página.
     */
    function exibirResultado(id, label, valor, classes = '') {
        const saidaDiv = document.getElementById(id);
        const p = document.createElement('p');
        p.className = `resultado-item ${classes}`;
        p.innerHTML = `<strong class="font-medium text-gray-700">${label}:</strong> <span class="text-gray-900">${valor}</span>`;
        saidaDiv.appendChild(p);
    }

    /**
     * Função principal que processa a entrada.
     */
    function processar() {
        const txt = document.getElementById("entrada").value.trim();
        const saidaDiv = document.getElementById("saida");
        
        // Limpa resultados anteriores
        saidaDiv.innerHTML = ''; 
        
        // Esconde o botão e o formulário de inclusão ao processar novo item
        document.getElementById('btn-abrir-inclusao').classList.add('hidden');
        document.getElementById('form-inclusao').classList.add('hidden');
        ultimoCadastroSugerido = ''; // Limpa o cadastro anterior

        if (!txt) {
            saidaDiv.innerHTML = '<p class="text-red-600 font-medium">Formato inválido. Digite as medidas.</p>';
            return;
        }

        const partes = txt.split('x').map(v => parseFloat(v.replace(',', '.')));

        if (partes.some(isNaN)) {
            saidaDiv.innerHTML = '<p class="text-red-600 font-medium">Entrada inválida. Verifique se os números estão corretos.</p>';
            return;
        }

        try {
            let tipoSelecionado = document.getElementById('tipoMaterial').value;
            let materialDetectado = '';
            let cadastroSugerido = 'N/A';
            let chapaDetectada = ''; // Para Tubos/Perfis U
            let espessuraFracao = ''; // Para Barras/Cantoneiras

            const esp = partes[partes.length - 1];
            
            // Auto-detecção se necessário
            let tipoFinal = tipoSelecionado;
            if (tipoFinal === 'auto') {
                tipoFinal = autoDetectarMaterial(partes);
                materialDetectado = `(Auto-detectado: ${document.querySelector(`#tipoMaterial option[value="${tipoFinal}"]`)?.textContent || 'Falha'})`;
            } else {
                 materialDetectado = document.querySelector(`#tipoMaterial option[value="${tipoFinal}"]`).textContent;
            }

            // --- LÓGICA DE CADASTRO POR MATERIAL ---
            
            switch (tipoFinal) {
                case 'tubo_retangular':
                    // Ex: 50x30x2.0 (3 partes) ou 50x2.0 (2 partes = Quadrado)
                    chapaDetectada = detectarChapa(esp);
                    let ladoA = arredondaComercial(partes[0]);
                    let ladoB = ladoA;
                    if (partes.length === 3) {
                        ladoB = arredondaComercial(partes[1]);
                    } else if (partes.length !== 2) {
                        throw new Error("Tubo Quadrado/Retangular deve ter 2 ou 3 medidas (Ex: 50x30x2.0 ou 50x2.0)");
                    }
                    
                    let nomeTubo = (ladoA === ladoB) ? 'TUBO QUADRADO' : 'TUBO RETANGULAR';
                    cadastroSugerido = `${nomeTubo} ${ladoA}${(ladoA !== ladoB ? ' x ' + ladoB : '')} ${chapaDetectada}`;
                    break;

                case 'tubo_redondo':
                    // Ex: 50.8x2.0 (2 partes)
                    if (partes.length !== 2) throw new Error("Tubo Redondo deve ter 2 medidas (Ex: 50.8x2.0)");
                    chapaDetectada = detectarChapa(esp);
                    let diametro = arredondaComercial(partes[0]);
                    cadastroSugerido = `TUBO REDONDO ${diametro} ${chapaDetectada}`;
                    break;
                
                case 'cantoneira':
                    // Ex: 50.8x50.8x3.175 (3 partes)
                    // IMPORTANTE: Espessura de cantoneira é em polegada, não CH.
                    if (partes.length !== 3) throw new Error("Cantoneira deve ter 3 medidas (Ex: 25.4x25.4x3.175)");
                    let abaA = arredondaComercial(partes[0]);
                    let abaB = arredondaComercial(partes[1]);
                    espessuraFracao = arredondaComercial(partes[2]);
                    cadastroSugerido = `CANTONEIRA L ${abaA}${(abaA !== abaB ? ' x ' + abaB : '')} x ${espessuraFracao}`;
                    break;

                case 'barra_chata':
                    // Ex: 25.4x3.175 (2 partes)
                    // IMPORTANTE: Espessura de barra chata é em polegada, não CH.
                    if (partes.length !== 2) throw new Error("Barra Chata deve ter 2 medidas (Ex: 25.4x3.175)");
                    let largura = arredondaComercial(partes[0]);
                    espessuraFracao = arredondaComercial(partes[1]);
                    cadastroSugerido = `BARRA CHATA ${largura} x ${espessuraFracao}`;
                    break;

                case 'perfil_u':
                    // Ex: 75x40x2.65 (Simples, 3 partes) ou 75x40x15x2.65 (Enrijecido, 4 partes)
                    chapaDetectada = detectarChapa(esp);
                    let alma = arredondaComercial(partes[0]);
                    let aba = arredondaComercial(partes[1]);
                    let nomePerfil = 'PERFIL U SIMPLES';
                    if (partes.length === 4) {
                        nomePerfil = 'PERFIL U ENRIJECIDO';
                    } else if (partes.length !== 3) {
                         throw new Error("Perfil U deve ter 3 ou 4 medidas.");
                    }
                    cadastroSugerido = `${nomePerfil} ${alma} x ${aba} ${chapaDetectada}`;
                    break;

                case 'perfil_i_w':
                    // Ex: 152.4x76.2x4.76 (Alma x Aba x Espessura) - 3 partes
                    if (partes.length !== 3) throw new Error("Perfil I/W deve ter 3 medidas (Alma x Aba x Espessura Média)");
                    let almaViga = arredondaComercial(partes[0]);
                    let abaViga = arredondaComercial(partes[1]);
                    espessuraFracao = arredondaComercial(partes[2]); // Também em polegada
                    cadastroSugerido = `PERFIL I/W ${almaViga} x ${abaViga} x ${espessuraFracao}`;
                    break;
                
                case 'chapa':
                case 'chapa_zincada':
                    // --- LÓGICA COMPLETAMENTE REFEITA ---
                    
                    // 1. Encontrar a espessura (sempre o menor valor)
                    const espChapa = Math.min(...partes); // Ex: 1.25 ou 0.95
                    
                    // 2. Pegar as outras medidas (dimensões)
                    const dimensoesMm = partes.filter(p => p !== espChapa); // Ex: [1000] ou [1000, 3000]

                    // 3. Detectar a chapa (gauge) com a espessura correta
                    let nomeChapa = (tipoFinal === 'chapa_zincada') ? 'CHAPA GALVANIZADA' : 'CHAPA';
                    chapaDetectada = detectarChapa(espChapa); // Ex: detectarChapa(1.25) -> CH 18
                    
                    // 4. Formatar as dimensões em metros
                    let dimensoesStr = '';
                    const dimensoesM = dimensoesMm.map(d => (d / 1000)).sort((a, b) => b - a); // Ex: [1] ou [3, 1]

                    if (dimensoesM.length === 2) {
                        // Ex: 0.95 x 1000 x 3000 -> dimensoesM = [3, 1]
                        dimensoesStr = `${dimensoesM[0]}x${dimensoesM[1]} m`; // "3x1 m"
                    } else if (dimensoesM.length === 1) {
                        // Ex: 1.25 x 1000 -> dimensoesM = [1]
                        if (dimensoesM[0] === 1) {
                            dimensoesStr = "2x1 m"; // Seu padrão de 2000x1000
                        } else if (dimensoesM[0] === 1.2 || dimensoesM[0] === 1.25) {
                            dimensoesStr = "2.5x1.25 m"; // Outro padrão comum 2500x1250
                        } else {
                            dimensoesStr = `${dimensoesM[0]}m (largura)`;
                        }
                    } else {
                        // Ex: 1.25 (só espessura)
                        dimensoesStr = '(Dimensões não especificadas)';
                    }
                    
                    // 5. Montar o cadastro (Ex: Chapa galvanizada 18 (1,25 mm) 2x1 m)
                    cadastroSugerido = `${nomeChapa} ${chapaDetectada} (${espChapa.toString().replace('.', ',')} mm) ${dimensoesStr}`;
                    break;
                    // --- FIM DA LÓGICA REFEITA ---

                default:
                    materialDetectado = 'Não Identificado / Falha no Auto-Detect';
                    cadastroSugerido = 'N/A - Selecione o material correto na lista.';
            }


            // Exibindo os resultados de forma organizada
            const mmLine = partes.join(' × ') + ' mm';
            // NOVO: Calcula as polegadas exatas (decimais)
            const inchExatas = partes.map(v => mmParaInch(v).toFixed(3).replace('.', ',') + '"').join(' × ');
            const inchCom = partes.map(arredondaComercial).join(' × ');

            exibirResultado("saida", "Entrada Bruta", txt);
            exibirResultado("saida", "Material", materialDetectado, 'text-blue-700');
            exibirResultado("saida", "Dimensões (mm)", mmLine);
            // NOVO: Exibe as polegadas exatas
            exibirResultado("saida", "Dimensões (pol. exatas)", inchExatas);
            exibirResultado("saida", "Dimensões (pol. comercial)", inchCom);
            
            exibirResultado("saida", "Cadastro Sugerido", cadastroSugerido, 'text-green-700 font-bold text-lg mt-2');

            // --- NOVA LÓGICA ---
            // Se o cadastro foi um sucesso, guarda o nome e mostra o botão "+ Incluir"
            if (cadastroSugerido !== 'N/A - Selecione o material correto na lista.') {
                ultimoCadastroSugerido = cadastroSugerido;
                document.getElementById('btn-abrir-inclusao').classList.remove('hidden');
            }
            // --- FIM DA NOVA LÓGICA ---

        } catch (error) {
            console.error(error);
            saidaDiv.innerHTML = `<p class="text-red-600 font-medium">Ocorreu um erro: ${error.message}</p>`;
        }
    }

    // --- FUNÇÕES DA NOVA SEÇÃO DE INCLUSÃO ---

    /**
     * Mostra o formulário para adicionar dados da nota.
     */
    function abrirFormInclusao() {
        document.getElementById('form-inclusao').classList.remove('hidden');
        document.getElementById('btn-abrir-inclusao').classList.add('hidden');
        
        // Limpa campos e erros anteriores
        document.getElementById('peso-total').value = '';
        document.getElementById('peso-unidade').value = '';
        document.getElementById('valor-total').value = '';
        document.getElementById('inclusao-erro').textContent = '';
        
        // NOVO: Reseta o formulário para o modo "Adicionar"
        document.getElementById('edit-item-id').value = '';
        document.getElementById('btn-confirmar-inclusao').textContent = 'Confirmar';
    }

    /**
     * Cancela a inclusão e esconde o formulário.
     */
    function cancelarInclusao() {
        document.getElementById('form-inclusao').classList.add('hidden');
        // Só mostra o botão "+ Incluir" se houver um cadastro sugerido
        if (ultimoCadastroSugerido) {
            document.getElementById('btn-abrir-inclusao').classList.remove('hidden');
        }
        
        // NOVO: Reseta o formulário
        document.getElementById('edit-item-id').value = '';
        document.getElementById('btn-confirmar-inclusao').textContent = 'Confirmar';
    }

    /**
     * Confirma os dados, faz o cálculo e ADICIONA ou ATUALIZA o item na lista.
     * Esta função foi reescrita para usar o array 'inventario'.
     */
    function confirmarInclusao() {
        const erroDiv = document.getElementById('inclusao-erro');
        erroDiv.textContent = '';

        // 1. Obter valores
        // MUDANÇA: Adicionado .replace(',', '.') para aceitar vírgula ou ponto
        const pesoTotal = parseFloat(document.getElementById('peso-total').value.replace(',', '.'));
        const pesoUnidade = parseFloat(document.getElementById('peso-unidade').value.replace(',', '.'));
        const valorTotal = parseFloat(document.getElementById('valor-total').value.replace(',', '.'));

        // 2. Validar
        if (isNaN(pesoTotal) || isNaN(pesoUnidade) || isNaN(valorTotal)) {
            erroDiv.textContent = 'Erro: Todos os campos devem ser números.';
            return;
        }
        if (pesoTotal <= 0 || pesoUnidade <= 0 || valorTotal <= 0) {
            erroDiv.textContent = 'Erro: Os valores devem ser maiores que zero.';
            return;
        }
        if (pesoUnidade > pesoTotal) {
            erroDiv.textContent = 'Erro: Peso unitário não pode ser maior que o peso total.';
            return;
        }

        // 3. Calcular Quantidade (Regra: Truncar decimais)
        const quantidadeCalculadaReal = pesoTotal / pesoUnidade;
        const quantidadeUsada = Math.trunc(quantidadeCalculadaReal); // Valor truncado

        if (quantidadeUsada === 0) {
            erroDiv.textContent = 'Erro: Quantidade calculada é zero. Verifique os pesos.';
            return;
        }

        // 4. Calcular Valor Unitário (Regra: Truncar em 4 decimais)
        const valorUnitarioCalculadoReal = valorTotal / quantidadeUsada;
        const valorUnitarioUsado = Math.floor(valorUnitarioCalculadoReal * 10000) / 10000; // Valor truncado
        
        // 5. Verificar se é "Adicionar" ou "Editar"
        const editId = document.getElementById('edit-item-id').value;

        if (editId) {
            // --- MODO EDIÇÃO ---
            const item = inventario.find(i => i.id === parseInt(editId));
            if (item) {
                // Atualiza os valores do item existente
                item.pesoTotal = pesoTotal;
                item.pesoUnidade = pesoUnidade;
                item.valorTotal = valorTotal;
                // --- NOVOS CAMPOS ---
                item.quantidadeReal = quantidadeCalculadaReal;
                item.quantidade = quantidadeUsada;
                item.valorUnitarioReal = valorUnitarioCalculadoReal;
                item.valorUnitarioTruncado = valorUnitarioUsado;
            }
        } else {
            // --- MODO ADIÇÃO ---
            const novoItem = {
                id: nextId++,
                nome: ultimoCadastroSugerido,
                pesoTotal: pesoTotal,
                pesoUnidade: pesoUnidade,
                valorTotal: valorTotal,
                // --- NOVOS CAMPOS ---
                quantidadeReal: quantidadeCalculadaReal,
                quantidade: quantidadeUsada, // O truncado
                valorUnitarioReal: valorUnitarioCalculadoReal,
                valorUnitarioTruncado: valorUnitarioUsado // O truncado
            };
            // Adiciona o novo item no início da lista (prepend)
            inventario.push(novoItem); 
        }

        // 6. Redesenhar a lista inteira
        renderInventario();

        // 7. Fechar e resetar o formulário
        cancelarInclusao();
    }

    /**
     * NOVO: Desenha a lista de inventário no HTML.
     */
    function renderInventario() {
        const listaDiv = document.getElementById('lista-inventario');
        listaDiv.innerHTML = ''; // Limpa a lista antiga

        // NOVO: Seleciona o container do Log
        const logContainer = document.getElementById('log-container');
        const logNaTela = document.getElementById('log-na-tela');

        // Mostra ou esconde o botão de exportar
        if (inventario.length > 0) {
            document.getElementById('btn-exportar').classList.remove('hidden');
            // NOVO: Mostra o log na tela e o preenche
            logContainer.classList.remove('hidden');
            logNaTela.textContent = gerarLogContent();
            
            // NOVO: Reseta o estado do botão toggle
            document.getElementById('log-na-tela').classList.remove('hidden');
            document.getElementById('btn-toggle-log').textContent = 'Esconder';

        } else {
            document.getElementById('btn-exportar').classList.add('hidden');
            // NOVO: Esconde o log na tela e o limpa
            logContainer.classList.add('hidden');
            logNaTela.textContent = '';
            listaDiv.innerHTML = '<p class="text-gray-500">Nenhum item incluído.</p>';
            return;
        }

        // Adiciona cada item do array no HTML
        inventario.forEach((item, index) => {
            const valorUnitarioStr = item.valorUnitarioTruncado.toFixed(4).replace('.', ',');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'py-4 border-b border-gray-200';
            itemDiv.setAttribute('data-item-id', item.id);
            
            // Desabilita botões de mover se estiver no topo ou no fim
            const upDisabled = (index === 0) ? 'disabled' : '';
            const downDisabled = (index === inventario.length - 1) ? 'disabled' : '';

            itemDiv.innerHTML = `
                <p class="font-bold text-gray-800">${item.nome}</p>
                <p class="text-gray-600">
                    <span class="font-medium">un:</span> ${item.quantidade}, 
                    <span class="font-medium">valor unitário:</span> R$ ${valorUnitarioStr}
                </p>
                <div class="flex flex-wrap gap-x-4 gap-y-1 mt-2 text-sm">
                    <!-- Botões de Ação -->
                    <button onclick="iniciarAlteracao(${item.id})" class="text-blue-600 hover:text-blue-800 font-medium">Alterar</button>
                    <button onclick="excluirItem(${item.id})" class="text-red-600 hover:text-red-800 font-medium">Excluir</button>
                    <!-- Botões de Posição -->
                    <button onclick="moverItem(${item.id}, 'up')" class="text-gray-500 hover:text-gray-800 ${upDisabled ? 'opacity-50 cursor-not-allowed' : ''}" ${upDisabled}>&#9650; Mover Cima</button>
                    <button onclick="moverItem(${item.id}, 'down')" class="text-gray-500 hover:text-gray-800 ${downDisabled ? 'opacity-50 cursor-not-allowed' : ''}" ${downDisabled}>&#9660; Mover Baixo</button>
                </div>
            `;
            listaDiv.appendChild(itemDiv);
        });
    }

    /**
     * NOVO: Prepara o formulário para editar um item.
     */
    function iniciarAlteracao(id) {
        const item = inventario.find(i => i.id === id);
        if (!item) return;

        // Mostra o formulário
        document.getElementById('form-inclusao').classList.remove('hidden');
        document.getElementById('btn-abrir-inclusao').classList.add('hidden');

        // Preenche com os dados do item
        document.getElementById('peso-total').value = item.pesoTotal;
        document.getElementById('peso-unidade').value = item.pesoUnidade;
        document.getElementById('valor-total').value = item.valorTotal;
        
        // Define o modo de edição
        document.getElementById('edit-item-id').value = id;
        document.getElementById('btn-confirmar-inclusao').textContent = 'Salvar Alteração';

        // Rola a tela para o formulário
        document.getElementById('form-inclusao').scrollIntoView({ behavior: 'smooth' });
    }

    /**
     * NOVO: Exclui um item da lista.
     */
    function excluirItem(id) {
        // Confirmação simples (descomente se quiser uma confirmação)
        // if (!confirm('Tem certeza que deseja excluir este item?')) {
        //     return;
        // }
        inventario = inventario.filter(i => i.id !== id);
        renderInventario();
    }

    /**
     * NOVO: Move um item para cima ou para baixo.
     */
    function moverItem(id, direcao) {
        const index = inventario.findIndex(i => i.id === id);

        if (direcao === 'up' && index > 0) {
            // Troca com o item anterior
            [inventario[index - 1], inventario[index]] = [inventario[index], inventario[index - 1]];
        } else if (direcao === 'down' && index < inventario.length - 1) {
            // Troca com o próximo item
            [inventario[index + 1], inventario[index]] = [inventario[index], inventario[index + 1]];
        }
        
        renderInventario();
    }

    /**
     * NOVO: Mostra ou esconde o <pre> do log na tela.
     */
    function toggleLog() {
        const logPre = document.getElementById('log-na-tela');
        const btn = document.getElementById('btn-toggle-log');
        if (logPre.classList.contains('hidden')) {
            logPre.classList.remove('hidden');
            btn.textContent = 'Esconder';
        } else {
            logPre.classList.add('hidden');
            btn.textContent = 'Mostrar';
        }
    }

    /**
     * NOVO: Gera o conteúdo de texto para o Log.
     * Esta função agora é usada tanto pela exportação quanto pela exibição na tela.
     */
    function gerarLogContent() {
        let logContent = 'Log de Inventário - ' + new Date().toLocaleString('pt-BR') + '\n\n';

        // Itera na ordem inversa (do mais antigo para o mais novo) para o log
        inventario.forEach(item => {
            logContent += `========================================\n`;
            logContent += `Item: ${item.nome}\n`;
            logContent += `--- Inputs da Calculadora ---\n`;
            logContent += `Peso Total (Kg): ${item.pesoTotal}\n`;
            logContent += `Peso Unidade (Kg): ${item.pesoUnidade}\n`;
            logContent += `Valor Total (R$): ${item.valorTotal}\n`;
            logContent += `--- Resultados ---\n`;
            // --- LINHAS MODIFICADAS ---
            logContent += `Quantidade Calculada: ${item.quantidadeReal} (Usado: ${item.quantidade})\n`;
            logContent += `Valor Unitário: ${item.valorUnitárioReal} (Usado: R$ ${item.valorUnitarioTruncado.toFixed(4).replace('.', ',')})\n`;
            // --- FIM DAS LINHAS MODIFICADAS ---
            logContent += `========================================\n\n`;
        });
        
        return logContent;
    }

    /**
     * NOVO: Controla a exibição da sidebar (régua).
     */
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar-regua');
        const overlay = document.getElementById('sidebar-overlay');
        
        const isOpen = sidebar.classList.contains('translate-x-0');
        
        if (isOpen) {
            sidebar.classList.remove('translate-x-0');
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        } else {
            sidebar.classList.remove('-translate-x-full');
            sidebar.classList.add('translate-x-0');
            overlay.classList.remove('hidden');
        }
    }

    /**
     * NOVO: Gera e baixa um arquivo .txt com o log do inventário.
     * (Agora usa a função gerarLogContent)
     */
    function exportarLog() {
        // 1. Gera o conteúdo do log
        const logContent = gerarLogContent();

        // 2. Cria e baixa o arquivo
        const blob = new Blob([logContent], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'log_inventario.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

</script>

</body>
</html>
